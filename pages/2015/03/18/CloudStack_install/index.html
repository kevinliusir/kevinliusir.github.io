<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>CloudStack_install</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Kevin">

    <!-- Le styles -->
    <link rel="stylesheet" href="http://www.feisblog.com/theme/css/bootstrap.min.css" type="text/css" />
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }
      .tag-1 {
        font-size: 13pt;
      }
      .tag-2 {
        font-size: 10pt;
      }
      .tag-2 {
        font-size: 8pt;
      }
      .tag-4 {
        font-size: 6pt;
     }
    </style>
    <link href="http://www.feisblog.com/theme/css/bootstrap-responsive.min.css" rel="stylesheet">
        <link href="http://www.feisblog.com/theme/css/font-awesome.css" rel="stylesheet">

    <link href="http://www.feisblog.com/theme/css/pygments.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="http://www.feisblog.com/theme/images/favicon.ico">
    <link rel="apple-touch-icon" href="http://www.feisblog.com/theme/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="http://www.feisblog.com/theme/images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="http://www.feisblog.com/theme/images/apple-touch-icon-114x114.png">

    <link href="http://www.feisblog.com/" type="application/atom+xml" rel="alternate" title="Kevin's Blog ATOM Feed" />

  </head>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="http://www.feisblog.com/index.html">Kevin's Blog  <strong>DevOps、大数据、云计算</strong></a>
          <div class="nav-collapse">
            <ul class="nav">
                          <li class="divider-vertical"></li>
                  <li >
                    <a href="http://www.feisblog.com/category/docker.html">
						<i class="icon-folder-open icon-large"></i>docker
					</a>
                  </li>
                  <li >
                    <a href="http://www.feisblog.com/category/xu-ni-hua.html">
						<i class="icon-folder-open icon-large"></i>虚拟化
					</a>
                  </li>
                  <li class="active">
                    <a href="http://www.feisblog.com/category/yun-ji-suan.html">
						<i class="icon-folder-open icon-large"></i>云计算
					</a>
                  </li>
                  <li >
                    <a href="http://www.feisblog.com/category/yun-wei-zi-dong-hua.html">
						<i class="icon-folder-open icon-large"></i>运维自动化
					</a>
                  </li>

                          <ul class="nav pull-right">
                                <li><a href="http://www.feisblog.com/archives.html"><i class="icon-th-list"></i>归档</a></li>
                          </ul>

            </ul>
            <!--<p class="navbar-text pull-right">Logged in as <a href="#">username</a></p>-->
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row">
        <div class="span9" id="content">
<section id="content">
        <article>
                <header>
                        <h1>
                                <a href=""
                                        rel="bookmark"
                                        title="Permalink to CloudStack_install">
                                        CloudStack_install
                                </a>
                        </h1>
                </header>
                <div class="entry-content">
                <div class="well">
<footer class="post-info">
<span class="label">Date</span>
<abbr class="published" title="2015-03-18T10:30:00+08:00">
        <i class="icon-calendar"></i>周三 18 三月 2015
</abbr>
<span class="label">By</span>
<a href="http://www.feisblog.com/author/kevin.html"><i class="icon-user"></i>Kevin</a>
<span class="label">Category</span>
<a href="http://www.feisblog.com/category/yun-ji-suan.html"><i class="icon-folder-open"></i>云计算</a>.


<span class="label">Tags</span>
	<a href="http://www.feisblog.com/tag/cloudstack.html"><i class="icon-tag"></i>CloudStack</a>
</footer><!-- /.post-info -->                </div>
                <h1>CloudStack的安装和使用</h1>
<hr />
<h2>目录</h2>
<h3>1.CloudStack简介</h3>
<h3>先决条件</h3>
<p>至少一个支持硬件虚拟化的计算机。如果是个人电脑，在主板bios里面开启下虚拟化。
CentOS 6.4 x86_64 的 minimal install CD <a href="http://mirrors.kernel.org/centos/6.4/isos/x86_64/CentOS-6.4-x86_64-minimal.iso">http://mirrors.kernel.org/centos/6.4/isos/x86_64/CentOS-6.4-x86_64-minimal.iso</a>
一个以xxx.xxx.xxx.1/24作为网关的C类地址并且该网络中不能存在DHCP服务器；运行Cloudstack 的机器不能使用动态地址。这样做只是为了简单起见，我的环境中是192.168.1.0/24网络。</p>
<h3>安装和规划cloudstack</h3>
<p>1.安装CentOS 6.7 x86_64 最小化安装
2.安装网络 
3.配置host文件
4.关闭selinux
5.配置NTP 
6.配置cloudstack 源</p>
<h3>配置NFS 存储</h3>
<p>主存储和辅助存储我们都使用NFS存储。接下来我们要设置两个NFS共享。首先安装nfs-utils。</p>
<h1>yum install nfs-utils</h1>
<p>现在我们在NFS服务器上配置两个不同的共享目录。我们需要在/etc/exports文件中分别配置一下。确保这个文件中包含下面内容：</p>
<p>/secondary <em>(rw,async,no_root_squash)
/primary </em>(rw,async,no_root_squash)</p>
<p>/secondary <em>(rw,async,no_root_squash)
/primary </em>(rw,async,no_root_squash)
自己测试玩玩的话，可以这样配置nfs，生产环境不能这样， * 表示所以客户端都能挂载这2个目录，当然这里把ip固定死也不是很好的解决方案，毕竟虚拟机也是要能挂载二级存储的，可以使用防火墙或者hosts.allow deny来控制</p>
<p>FAS2220A 作为/primary<br />
FAS2220B 作为/secondary</p>
<p>安装 cloudstack</p>
<p>cloudstack-setup-databases cloud:whfdc027@localhost --deploy-as=root:whfdc027</p>
<h3>CloudStack自定义KVM虚拟化本地存储路径</h3>
<p>方法很简单，修改kvm端 cloudstack agent配置文件agent.properties即可。</p>
<h1>vim /etc/cloudstack/agent/agent.properties</h1>
<p>local.storage.path=/data/</p>
<p>如何验证修改成功</p>
<p>使用软连接 
cd /var/lib/libvirt
cp  /var/lib/libvirt/<em> /data/kvm
rm -rf boot/ dnsmasq/ filesystems/ lxc/ network/ qemu/ 
ln -s /data/kvm/</em> ./</p>
<p>或者更有效的方法是： </p>
<p>ln -sf /var/lib/libvirt/images /home/xxx/my_images
<strong>
第二种方式</strong></p>
<p>添加第二个存储池</p>
<h1>virsh pool-dumpxml default &gt; pool.xml</h1>
<p>edit pool.xml # with new name and path</p>
<h1>virsh pool-create pool.xml</h1>
<h1>virsh pool-refresh name</h1>
<p>如果您打算需要删除xml文件如果您打算UUID字段保留默认池
One side note: You will need to delete the UUID field in the xml file if you intend to keep the default pool - no two pools defined can have the same UUID - but keep the brackets like so: '<uuid></uuid>'</p>
<p>http://www.ibm.com/support/knowledgecenter/linuxonibm/liaat/liaatsecstorotherdir.htm</p>
<p>https://ask.fedoraproject.org/en/question/9584/while-using-libvirt-how-can-i-use-a-location-other-than-varliblibvirtimages-to-store-my-images/</p>
<p>http://ask.xmodulo.com/change-default-location-libvirt-vm-images.html</p>
<div class="highlight"><pre><span class="o">[</span><span class="n">root</span><span class="vi">@cloud</span><span class="o">-</span><span class="n">agent01</span> <span class="n">images</span><span class="o">]</span><span class="c1"># virsh pool-list</span>
<span class="no">Name</span>                 <span class="no">State</span>      <span class="no">Autostart</span> 
<span class="o">-----------------------------------------</span>
<span class="n">acd2c7fb</span><span class="o">-</span><span class="mi">45</span><span class="n">dc</span><span class="o">-</span><span class="mi">4</span><span class="n">d1c</span><span class="o">-</span><span class="mi">901</span><span class="n">a</span><span class="o">-</span><span class="mo">060</span><span class="n">df1248434</span> <span class="n">active</span>     <span class="n">no</span>        
<span class="n">f9371e71</span><span class="o">-</span><span class="n">c689</span><span class="o">-</span><span class="mi">3</span><span class="n">e12</span><span class="o">-</span><span class="n">a6a6</span><span class="o">-</span><span class="n">fadf7712c964</span> <span class="n">active</span>     <span class="n">no</span>

<span class="c1">#virsh pool-dumpxml acd2c7fb-45dc-4d1c-901a-060df1248434  &gt; pool.xml</span>
<span class="c1">#virsh pool-destroy acd2c7fb-45dc-4d1c-901a-060df1248434</span>
<span class="c1">#virsh pool-create pool.xml</span>
</pre></div>


<h6></h6>
<p>cloudstack-setup-databases cloud:cloud@localhost --deploy-as=root:qwe123! </p>
<p>cloudstack-setup-management</p>
<p>4.8模板
http://d21ifhcun6b1t2.cloudfront.net/templates/4.2/systemvmtemplate-2013-06-12-master-kvm.qcow2.bz2</p>
<p>http://d21ifhcun6b1t2.cloudfront.net/templates/4.8/system*.qcow2.bz2</p>
<p>导入本地模板
/usr/share/cloudstack-common/scripts/storage/secondary/cloud-install-sys-tmplt -m /secondary</p>
<p>/usr/share/cloudstack-common/scripts/storage/secondary/cloud-install-sys-tmplt \
-m /secondary \
-u http://cloudstack.apt-get.eu/systemvm/4.6/systemvm64template-4.6.0-kvm.qcow2.bz2 \
-h kvm -F</p>
<h3>安装客户端</h3>
<p>1.设置host文件和主机名</p>
<h1>主机名</h1>
<p>sed -i s/HOSTNAME=localhost.localdomain/HOSTNAME=cloud-agent03.fdc.com.cn/g</p>
<h1>host 文件</h1>
<p>192.168.1.240 cloud-server cloud-server.fdc.com.cn
192.168.1.241 cloud-agent01 cloud-agent01.fdc.com.cn
192.168.1.242 cloud-agent02 cloud-agent02.fdc.com.cn
192.168.1.243 cloud-agent03 cloud-agent03.fdc.com.cn
192.168.1.244 cloud-agent04 cloud-agent04.fdc.com.cn
2.关闭selinux &amp;防火墙
echo "SELINUX=disabled" &gt; /etc/selinux/config
echo "SELINUXTYPE=targeted" &gt;&gt;/etc/selinux/config</p>
<h1>limit</h1>
<p>echo "<em>               soft    nproc             65535" &gt;&gt; /etc/security/limits.conf
echo "</em>               hard    nproc             65535" &gt;&gt; /etc/security/limits.conf
echo "<em>               soft    nofile             65535" &gt;&gt; /etc/security/limits.conf
echo "</em>               hard    nofile             65535" &gt;&gt; /etc/security/limits.conf</p>
<h1>iptables</h1>
<p>service iptables stop 
chkconfig iptables off </p>
<p>3.安装NTP、wget等
yum install ntp wget epel-release lrzsz -y 
/etc/init.d/ntpd start
chkconfig ntpd on </p>
<p>5.设置SSH 
echo "UseDNS no" &gt;&gt; /etc/ssh/sshd_config
echo "StrictHostKeyChecking no" &gt;&gt;/etc/ssh/ssh_config
/etc/init.d/sshd restart</p>
<p>4.替换阿里云yum源
mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup
wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo
yum clean all &amp;&amp; yum makecache &amp;&amp; yum update -y </p>
<p>4.安装cloud-agent 
配置cloudstackyum源并安装，我这里下载下来本地安装</p>
<p>yum localinstall /usr/src/cloudstack-agent-4.8.0-1.el6.x86_64.rpm /usr/src/cloudstack-common-4.8.0-1.el6.x86_64.rpm -y</p>
<p>rm -rf /usr/src/*.rpm</p>
<p>6.设置本地存储路径
mkdir -p /data/kvm/images</p>
<p>echo "local.storage.path=/data/kvm/images/" &gt;&gt; /etc/cloudstack/agent/agent.properties
/etc/init.d/cloudstack-agent restart</p>
<p>7.配置QEMU
KVM只有一个相对简单的配置项。我们需要编辑QEMU VNC配置。确保/etc/libvirt/qemu.conf文件有如下所示的行，并将其注释去掉。
vnc_listen=0.0.0.0</p>
<p>8.配置Libvirt
CloudStack使用libvirt管理虚拟机。因此正确的配置libvirt是非常重要的。Libvirt是cloud-agent的一个依赖组件，它应该已经安装好了。</p>
<p>为了实现动态迁移libvirt需要监听不可靠的TCP连接。还需要关闭libvirts尝试使用组播DNS进行广播。这些都是在 /etc/libvirt/libvirtd.conf文件中进行配置。
设置下列参数：
listen_tls = 0
listen_tcp = 1
tcp_port = "16059"
auth_tcp = "none"
mdns_adv = 0
仅仅在libvirtd.conf中启用”listen_tcp”是不够的，我们还必须修改/etc/sysconfig/libvirtd中的参数:
取消下行的注释：</p>
<h1>LIBVIRTD_ARGS="--listen"</h1>
<p>重启libvirt</p>
<h1>service libvirtd restart</h1>
<p>KVM配置完成结束对KVM的安装和配置之后，接下来需要在CloudStack管理界面中实际配置我们的云。</p>
<h2></h2>
<h3>2.KVM环境搭建</h3>
<p>1.如何规划cloud环境
NFS带宽如何？NFS 到服务器最好使用1G带宽
宿主机性能如何？内存，CPU性能？
如果是本地硬盘，本地硬盘空间如何？是否够用几台服务器的硬盘的存储？
集群中需要多少个主存储？且总存储量多大？
每个资源域需要多少个二级存储？</p>
<h3>3.KVM 生产应用</h3>
<h3>3.概念</h3>
<p>Cluster 是多个主机组成的一个集群。同一个 cluster 中的主机有相同的硬件，相同的 Hypervisor，和共用同样的存储。同一个 cluster 中的虚拟机，可以实现无中断服务地从一个主机迁移到另外一个上。</p>
<h4>主存储（Primary Storage）</h4>
<p>它为该 cluster 中的主机的全部虚拟机提供磁盘卷。一个 cluster 至少有一个一级存储，且在部署时位置要临近主机以提供高性能。</p>
<h4>二级存储</h4>
<p>Secondary Storage VM 二级存储虚拟机简称ssvm， 作为系统虚机的一种，在cloudstack中扮演了很重要的角色，没有它很多功能都无法实现。简单来说ssvm主要用来管理二级存储，也就是对二级存储相关的操作都会通过它来完成。每一个资源域可以有多个SSVM， 当SSVM被删除或停止，它会自动被重建并启动。</p>
<h3>4.Cloudstack存储在本地</h3>
<p>启用本地存储：
不启用本地存储话，所有的虚拟机硬盘文件将存在网络存储服务器上，这样可以达到在不停机的情况下动态迁移虚机，保证虚拟机的高可用性。但凡事有利必有弊，如果没有硬件支持的情况下，NFS无法保证高可用性，另外虚机频繁读写的话，性能将受网络约束。因此请谨慎选择。
注：在“启用本地存储”上打勾的话，会弹出一个提示框。它的意思是系统虚机可以在本地存储上启动也可以在网络存储上启动。如果你想让系统虚机在本地存储上启动，则需要改一个全局参数，如果你想让系统虚机在网络存储上启动，则需要在创建完区域后还必须将网络主存储添加到区域上，系统虚机才能启动。</p>
<p>再注：“启用本地存储”后远没有它提示框中说的那么简单，你必须之后在“服务提供 – 计算方案”、“服务提供 – 磁盘方案”处添加使用本地存储的方案才能真正使用，否则创建虚拟机必然失败。</p>
<h3>如何优化cloudstack</h3>
<h3>如何优化KVM</h3>
<h3>如何监控cloudstack</h3>
<h3>本地存储的虚拟机如何动态扩展硬盘</h3>
<h3>本地存储的虚拟机如何动态扩展内存和CPU</h3>
<h3>创建模板</h3>
<p>1.通过ISO 安装完操作系统
2.修改操作系统默认配置
http://cloudstack-administration.readthedocs.org/zh_CN/latest/templates.html 参考</p>
<div class="highlight"><pre><span class="c1">#1.修改网络配置文件</span>
<span class="c1">#vim /etc/sysconfig/network-scripts/ifcfg-eth0</span>
<span class="no">DEVICE</span><span class="o">=</span><span class="n">eth0</span>
<span class="no">TYPE</span><span class="o">=</span><span class="no">Ethernet</span>
<span class="no">BOOTPROTO</span><span class="o">=</span><span class="n">dhcp</span>
<span class="no">ONBOOT</span><span class="o">=</span><span class="n">yes</span>
<span class="c1">#2.删除MAC与网卡绑定</span>
<span class="c1">#rm -f /etc/udev/rules.d/70-persistent-net.rules</span>
<span class="c1">#rm -f /etc/udev/rules.d/70-persistent-net.rules</span>
<span class="c1">#3移除SSH Keys</span>
<span class="n">rm</span> <span class="o">-</span><span class="n">f</span> <span class="sr">/etc/ss</span><span class="n">h</span><span class="o">/*</span><span class="n">key</span><span class="o">*</span>
<span class="c1">#4.清楚日志文件</span>
<span class="n">cat</span> <span class="sr">/dev/nu</span><span class="n">ll</span> <span class="o">&gt;</span> <span class="sr">/var/</span><span class="n">log</span><span class="o">/</span><span class="n">audit</span><span class="o">/</span><span class="n">audit</span><span class="o">.</span><span class="n">log</span> <span class="mi">2</span><span class="o">&gt;</span><span class="sr">/dev/nu</span><span class="n">ll</span>
<span class="n">cat</span> <span class="sr">/dev/nu</span><span class="n">ll</span> <span class="o">&gt;</span> <span class="sr">/var/</span><span class="n">log</span><span class="o">/</span><span class="n">wtmp</span> <span class="mi">2</span><span class="o">&gt;</span><span class="sr">/dev/nu</span><span class="n">ll</span>
<span class="n">logrotate</span> <span class="o">-</span><span class="n">f</span> <span class="sr">/etc/</span><span class="n">logrotate</span><span class="o">.</span><span class="n">conf</span> <span class="mi">2</span><span class="o">&gt;</span><span class="sr">/dev/nu</span><span class="n">ll</span>
<span class="n">rm</span> <span class="o">-</span><span class="n">f</span> <span class="sr">/var/</span><span class="n">log</span><span class="o">/*-*</span> <span class="sr">/var/</span><span class="n">log</span><span class="o">/*.</span><span class="n">gz</span> <span class="mi">2</span><span class="o">&gt;</span><span class="sr">/dev/nu</span><span class="n">ll</span>

<span class="c1">#5.清楚历史记录</span>
<span class="n">history</span> <span class="o">-</span><span class="n">c</span>
<span class="n">unset</span> <span class="no">HISTFILE</span>
<span class="c1">#6.</span>


<span class="n">echo</span> <span class="s2">&quot;SELINUX=disabled&quot;</span> <span class="o">&gt;</span> <span class="sr">/etc/se</span><span class="n">linux</span><span class="o">/</span><span class="n">config</span>
<span class="n">echo</span> <span class="s2">&quot;SELINUXTYPE=targeted&quot;</span> <span class="o">&gt;&gt;</span><span class="sr">/etc/se</span><span class="n">linux</span><span class="o">/</span><span class="n">config</span>
<span class="n">echo</span> <span class="s2">&quot;*               soft    nproc             65535&quot;</span> <span class="o">&gt;&gt;</span> <span class="sr">/etc/se</span><span class="n">curity</span><span class="o">/</span><span class="n">limits</span><span class="o">.</span><span class="n">conf</span>
<span class="n">echo</span> <span class="s2">&quot;*               hard    nproc             65535&quot;</span> <span class="o">&gt;&gt;</span> <span class="sr">/etc/se</span><span class="n">curity</span><span class="o">/</span><span class="n">limits</span><span class="o">.</span><span class="n">conf</span>
<span class="n">echo</span> <span class="s2">&quot;*               soft    nofile             65535&quot;</span> <span class="o">&gt;&gt;</span> <span class="sr">/etc/se</span><span class="n">curity</span><span class="o">/</span><span class="n">limits</span><span class="o">.</span><span class="n">conf</span>
<span class="n">echo</span> <span class="s2">&quot;*               hard    nofile             65535&quot;</span> <span class="o">&gt;&gt;</span> <span class="sr">/etc/se</span><span class="n">curity</span><span class="o">/</span><span class="n">limits</span><span class="o">.</span><span class="n">conf</span>
<span class="sr">/etc/ini</span><span class="n">t</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">iptables</span> <span class="n">stop</span>
<span class="n">chkconfig</span> <span class="n">iptables</span> <span class="n">off</span> 

<span class="n">yum</span> <span class="n">install</span> <span class="n">vim</span> <span class="n">lrzsz</span> <span class="n">wget</span> <span class="n">epel</span><span class="o">-</span><span class="n">release</span> <span class="n">ntpdate</span> <span class="o">-</span><span class="n">y</span>
<span class="c1">#配置时间同步</span>
<span class="n">ntpdate</span> <span class="n">time</span><span class="o">-</span><span class="n">a</span><span class="o">.</span><span class="n">nist</span><span class="o">.</span><span class="n">gov</span>
<span class="n">hwclock</span> <span class="o">--</span><span class="n">systohc</span>
<span class="n">echo</span> <span class="s2">&quot;0 0 * * * root /usr/sbin/ntpdate time-a.nist.gov&quot;</span>  <span class="o">&gt;&gt;</span>  <span class="sr">/etc/</span><span class="n">crontab</span>
<span class="c1">#SSH </span>
<span class="n">echo</span> <span class="s2">&quot;UseDNS no&quot;</span> <span class="o">&gt;&gt;</span> <span class="sr">/etc/ss</span><span class="n">h</span><span class="o">/</span><span class="n">sshd_config</span>
<span class="n">echo</span> <span class="s2">&quot;StrictHostKeyChecking no&quot;</span> <span class="o">&gt;&gt;</span><span class="sr">/etc/ss</span><span class="n">h</span><span class="o">/</span><span class="n">ssh_config</span>
<span class="sr">/etc/ini</span><span class="n">t</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">sshd</span> <span class="n">restart</span>
<span class="c1">#配置阿里云镜像源</span>
<span class="n">mv</span> <span class="sr">/etc/</span><span class="n">yum</span><span class="o">.</span><span class="n">repos</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="no">CentOS</span><span class="o">-</span><span class="no">Base</span><span class="o">.</span><span class="n">repo</span> <span class="sr">/etc/</span><span class="n">yum</span><span class="o">.</span><span class="n">repos</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="no">CentOS</span><span class="o">-</span><span class="no">Base</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">backup</span>
<span class="n">wget</span> <span class="o">-</span><span class="n">O</span> <span class="sr">/etc/</span><span class="n">yum</span><span class="o">.</span><span class="n">repos</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="no">CentOS</span><span class="o">-</span><span class="no">Base</span><span class="o">.</span><span class="n">repo</span> <span class="ss">http</span><span class="p">:</span><span class="sr">//mi</span><span class="n">rrors</span><span class="o">.</span><span class="n">aliyun</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">repo</span><span class="o">/</span><span class="no">Centos</span><span class="o">-</span><span class="mi">6</span><span class="o">.</span><span class="n">repo</span>
<span class="n">yum</span> <span class="n">clean</span> <span class="n">all</span> <span class="o">&amp;&amp;</span> <span class="n">yum</span> <span class="n">makecache</span> <span class="o">&amp;&amp;</span> <span class="n">yum</span> <span class="n">update</span> <span class="o">-</span><span class="n">y</span> 



<span class="c1">#去除主机名相关配置</span>
<span class="c1">#这样做是为了后面利用该Template创建的Instance能够自动生成特有的主机名</span>
<span class="c1">#vim /etc/hosts</span>
<span class="err">注释或删除以下内容</span>
<span class="c1">#127.0.1.1 Template-Instance.cs1cloud.internal Template-Instance</span>

<span class="err">将</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hostname</span><span class="err">文件更名或删除</span>
<span class="n">ubuntu</span><span class="vi">@Template</span><span class="o">-</span><span class="ss">Instance</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">sudo</span> <span class="n">mv</span> <span class="sr">/etc/</span><span class="n">hostname</span> <span class="sr">/etc/</span><span class="n">hostname</span><span class="o">.</span><span class="n">template</span>

<span class="c1">#关闭实例</span>
<span class="c1">#sync</span>
<span class="c1">#shutdown -h now</span>
</pre></div>


<p>安装openssh client和server (通过View console)
ubuntu@Template-Instance:~$ sudo apt-get install ssh</p>
<p>后面的步骤就可以通过SSH来完成了。</p>
<p>配置国内的网易镜像源
ubuntu@Template-Instance:~$ sudo sed -i s/us.archive.ubuntu.com/mirrors.163.com/g /etc/apt/sources.list
ubuntu@Template-Instance:~$ sudo sed -i s/security.ubuntu.com/mirrors.163.com/g /etc/apt/sources.list
ubuntu@Template-Instance:~$ sudo apt-get update</p>
<p>配置sudo用户组免密码切换
ubuntu@Template-Instance:~$ sudo visudo
%sudo ALL=(ALL:ALL) NOPASSWD:ALL
%admin ALL=(ALL) NOPASSWD:ALL</p>
<p>cccc
关闭Instance
ubuntu@Template-Instance:~$ sudo sync
ubuntu@Template-Instance:~$ sudo poweroff</p>
<hr />
<h3>安装windows模板</h3>
<p>参考： http://cloudstack-administration.readthedocs.org/zh_CN/latest/templates.html#system-preparation-for-windows-server-2003-r2</p>
<hr />
<p>问题1：
上传镜像Connection timed out
： 因为二级存储配置错误</p>
<p>2.删除默认的网络导致系统VM无法启动
有时因为各种原因，例如在控制台错误的配置了一些数据，需要重新初始化时，可以删除 CloudStack 的数据库，步骤如下：
在命令行下：
mysql –u root <password>
mysql&gt; drop database cloud; drop database cloud_usage;</p>
<h1>cloud-setup-databases cloud:<dbpassword>@localhost --deploy-as=root:<password></h1>
<h1>cloud-setup-management</h1>
<p>然后重复本节的操作。
附：CloudStack 的 Web Console 界面是可以定制化的。</p>
<p>问题3：虚拟机无法访问
需要设置默认安全策略</p>
<h2>问题4： 销毁VM 但是镜像还是存在</h2>
<p>是因为cloudstack 默认情况需要在销毁VM实例24小时后才正式删除，防止普通账户误删除操作，若需要可以更改"全局参数延迟时间"实现快速删除
调整全局设置expunge.delay 和expungeinterval 并重启cloustack</p>
<h2><strong>问题5：VM Stop 和delete CPU和内存资源不释放</strong></h2>
<p>capacity.skipcounting.hours    ---Time (in seconds) to wait before release VM's cpu and memory when VM in stopped state 3600    </p>
<p>调整：VM Stop和释放CPU内存资源之间的时间间隔（秒）；类型：整数；默认：3600
check.pod.cidrs</p>
<h2>问题6：VM卷快照和VM快照的问题</h2>
<p>http://ask.cloudstack-china.org/question/166  参考
此问题，因为你的qemu-img版本问题，不支持“-s”参数，导致快照失败。</p>
<p>CloudStack针对kvm虚拟机的卷做快照时，使用qemu-img -s 命令，而在rhel、centos新的发行版中，貌似把“-s”参数取消了（或者使用了其他参数）。
具体信息，可查看官方bug说明：https://issues.apache.org/jira ... -7300</p>
<p>rhel、centos 6.x版本的，可以使用附件中的qemu-img的包，
从该包中提取qemu-img程序，并覆盖到kvm主机中，重启libvirtd即可。
或者用该链接中下载：
http://vault.centos.org/6.4/up ... 4.rpm
qemu-img-0.12_.1_.2-2_.355_.el6_4_4_.1_.x86_64_.rar</p>
<h3>参考文档</h3>
<p>http://www.oschina.net/question/54100_137627?fromerr=rUUWPFjj
http://www.ibm.com/developerworks/cn/cloud/library/1303_chenyz_cloudstack/
http://my.oschina.net/fufangchun/blog/337695?fromerr=qxwfb3Fo
http://54im.com/%E4%BA%91%E8%AE%A1%E7%AE%97/cloudstack/%E7%AE%80%E5%8D%95%E9%83%A8%E7%BD%B2cloudstackcentos6-5%E5%AE%89%E8%A3%85cloudstack-4-3%E4%B9%8B%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3.html
http://54im.com/%E4%BA%91%E8%AE%A1%E7%AE%97/cloudstack/%E7%AE%80%E5%8D%95%E9%83%A8%E7%BD%B2cloudstackcentos6-5%E5%AE%89%E8%A3%85cloudstack-4-3%E4%B9%8B%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3.html 比较详细的介绍</p>
<p>http://www.openwebit.com/c/common-cloudstack-issues-and-their-solutions/   cloudstack 常见的问题
http://bbs.chinaunix.net/thread-4065267-1-1.html 常见问题</p>
                </div><!-- /.entry-content -->
                <div class="comments">
                <h2>Comments !</h2>
                        <div id="disqus_thread"></div>
                        <script type="text/javascript">
                           var disqus_identifier = "pages/2015/03/18/CloudStack_install/";
                           (function() {
                                var dsq = document.createElement('script');
                                dsq.type = 'text/javascript'; dsq.async = true;
                                dsq.src = 'http://feisblog.disqus.com/embed.js';
                                (document.getElementsByTagName('head')[0] ||
                                 document.getElementsByTagName('body')[0]).appendChild(dsq);
                          })();
                        </script>
                </div>
        </article>
</section>
        </div><!--/span-->

                <div class="span3 well sidebar-nav" id="sidebar">
<ul class="nav nav-list">
<li class="nav-header"><h4><i class="icon-external-link"></i>友情链接</h4></li>
    <li><a href="https://github.com/kevinliusir"><i class="icon-external-link"></i>My GitHub</a></li>
    <li><a href="http://supernetwork.blog.51cto.com"><i class="icon-external-link"></i>My 51CTO Blog</a></li>
<li class="nav-header"><h4><i class="icon-home icon-large"></i> social</h4></li>
<!--
<li><a href="http://www.feisblog.com/" rel="alternate"><i class="icon-bookmark icon-large"></i>atom feed</a></li>
-->

    <li><a href="http://feisblog.com/feeds/all.atom.xml"><i class="icon-RSS-sign icon-large"></i>RSS</a></li>

<li class="nav-header"><h4><i class="icon-folder-close icon-large"></i>日志分类</h4></li>
<li>
<a href="http://www.feisblog.com/category/docker.html">
    <i class="icon-folder-open icon-large"></i>docker
</a>
</li>
<li>
<a href="http://www.feisblog.com/category/xu-ni-hua.html">
    <i class="icon-folder-open icon-large"></i>虚拟化
</a>
</li>
<li>
<a href="http://www.feisblog.com/category/yun-ji-suan.html">
    <i class="icon-folder-open icon-large"></i>云计算
</a>
</li>
<li>
<a href="http://www.feisblog.com/category/yun-wei-zi-dong-hua.html">
    <i class="icon-folder-open icon-large"></i>运维自动化
</a>
</li>

<li class="nav-header"><h4><i class="icon-tags icon-large"></i>标签</h4></li>


</ul>        </div><!--/.well -->

      </div><!--/row-->

      <hr>

      <footer>
        <address id="about">
                Proudly powered by <a href="http://pelican.notmyidea.org/">Pelican <i class="icon-external-link"></i></a>,
                                which takes great advantage of <a href="http://python.org">Python <i class="icon-external-link"></i></a>.
        </address><!-- /#about -->

        <p>The theme is from <a href="http://twitter.github.com/bootstrap/">Bootstrap from Twitter <i class="icon-external-link"></i></a>,
                   and <a href="http://fortawesome.github.com/Font-Awesome/">Font-Awesome <i class="icon-external-link"></i></a>, thanks!</p>
      </footer>

    </div><!--/.fluid-container-->


<script type="text/javascript">
    var disqus_shortname = 'feisblog';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

    <!-- Le javascript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="http://www.feisblog.com/theme/js/jquery-1.7.2.min.js"></script>
    <script src="http://www.feisblog.com/theme/js/bootstrap.min.js"></script>
  </body>
</html>